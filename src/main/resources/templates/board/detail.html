<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>게시글 상세보기</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
</head>
<body>
<div class="container">
  <h1 class="my-4">게시글 상세보기</h1>

  <div class="card">
    <div class="card-body">
      <h5 class="card-title" id = "board-title" ></h5>

      <h6 class="card-subtitle mb-2 text-muted">
        작성자: <span id="board-author"></span>
      </h6>

      <p class="card-text" id = "board-content"></p>

      <p class="card-text">
        <small class="text-muted">조회수: <span id = "board-views">0</span></small>
      </p>

      <p class="card-text">
        <small class="text-muted" id="board-createdAt"></small>
        <small class="text-muted" id="board-updateAt"></small>
      </p>



    </div>
  </div>

  <div class="mt-3" id="action-buttons" data-author-id="">
    <a href="/" class="btn btn-secondary">목록으로 돌아가기</a>
  </div>

  <hr class="my-4">
  <h3>댓글</h3>

  <div class="mt-4">
    <h4>댓글 작성</h4>
    <form id="comment-form">
      <textarea name="content" class="form-control mb-2" rows="3" placeholder="댓글 내용을 입력하세요" required></textarea>
      <button type="submit" class="btn btn-primary">댓글 작성</button>
    </form>
  </div>

  <div id="comments-section" class="mb-4 mt-4">
    <ul id="comment-list" class="list-group">
    </ul>
  </div>
</div>

<script>
  // JWT 토큰을 파싱하는 함수 (jwt-decode 라이브러리 없이 구현)
  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    } catch (error) {
      console.error("JWT 파싱 오류:", error);
      return null;
    }
  }

  // 페이지 로드 시 실행되는 함수
  // detail.html <script> 태그 내부

  // ... (parseJwt 함수는 그대로 유지) ...

  document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('accessToken');

    // 수정 및 삭제 버튼 요소 가져오기 (초기에 display: none; 상태)
    const editBtn = document.getElementById('editBtn');
    const deleteBtn = document.getElementById('deleteBtn');

    // 게시글 작성자의 userId를 HTML data- 속성에서 안전하게 가져오기
    const boardAuthorH6Element = document.querySelector('h6[data-board-author-user-id]');
    const boardWriterId = boardAuthorH6Element ? boardAuthorH6Element.dataset.boardAuthorUserId : null;

    const boardId = window.location.pathname.split('/').pop();

    function renderBoard(board) {
      document.getElementById('board-title').textContent = board.title;
      document.getElementById('board-author').textContent = board.nickname;
      document.getElementById('board-content').textContent = board.content;
      document.getElementById('board-views').textContent = board.totalViews;
      document.getElementById('board-createdAt').textContent = '작성일: ' + new Date(board.createdAt).toLocaleString();

      // 수정/삭제 버튼 로직을 위해 작성자 ID를 data 속성에 저장
      document.getElementById('action-buttons').dataset.authorId = board.userId;
    }

    function renderComments(comments, container) {
      container.innerHTML = ''; // 기존 댓글 목록 초기화

      if (!comments) return;

      comments.forEach(comment => {
        const li = document.createElement('li');
        li.className = 'list-group-item';

        if (comment.deleted) {
          li.innerHTML = `<p class="text-muted">${comment.content}</p>`;
        } else {
          li.innerHTML = `
                    <strong>${comment.nickname}</strong>
                    <p style="margin: 5px 0;">${comment.content}</p>
                    <small class="text-muted">${new Date(comment.createdAt).toLocaleString()}</small>
                `;
        }
        container.appendChild(li);

        // 대댓글이 있으면 재귀 호출
        if (comment.children && comment.children.length > 0) {
          const childUl = document.createElement('ul');
          childUl.className = 'list-group mt-2 ml-4';
          li.appendChild(childUl);
          renderComments(comment.children, childUl);
        }
      });
    }
    fetch(`/api/board/${boardId}`)
            .then(response => {
              if (!response.ok) {
                throw new Error("게시글 정보를 불러올 수 없습니다.")
              }
              return response.json();
            })
            .then(data => {
              renderBoard(data);
              renderComments(data.comments, document.getElementById('comment-list'));
              setupActionButtons(data.userId);
              setupCommentForm(boardId);
            })
            .catch(error => {
              alert(error.message);
              window.location.href = '/';
            })

    if (token) {
      const decodedToken = parseJwt(token);
      // 토큰 페이로드에 'userId' 클레임이 있다고 가정. 없다면 'sub' 등 다른 키를 확인하세요.
      // 현재 userId가 문자열이므로, 파싱된 userId도 문자열일 것입니다.
      const currentUserId = decodedToken ? (decodedToken.userId || decodedToken.sub) : null;

      // 두 ID가 모두 존재하고, 그 문자열 값이 정확히 일치하는지 확인
      if (currentUserId && boardWriterId && currentUserId === boardWriterId) {
        editBtn.style.display = 'inline-block';
        deleteBtn.style.display = 'inline-block';
      }

    }
  });
  function setupActionButtons(authorId) {
    const token = localStorage.getItem('accessToken');
    if (!token) return;

    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      const currentUserId = payload.id; // JWT 페이로드에 id가 있다고 가정

      if (currentUserId === authorId) {
        const container = document.getElementById('action-buttons');
        const boardId = window.location.pathname.split('/').pop();

        const editBtn = document.createElement('a');
        editBtn.href = `/board/edit/${boardId}`; // 수정 페이지 URL
        editBtn.className = 'btn btn-warning';
        editBtn.textContent = '수정';

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-danger ml-2';
        deleteBtn.textContent = '삭제';
        deleteBtn.onclick = () => deleteBoard(boardId);

        container.prepend(deleteBtn);
        container.prepend(editBtn);
      }
    } catch (e) {
      console.error("토큰 처리 중 오류 발생:", e);
    }
  }
  function setupCommentForm(boardId) {
    const commentForm = document.getElementById('comment-form');
    commentForm.addEventListener('submit', function (event) {
      event.preventDefault(); // 폼 기본 동작 방지

      const content = event.target.content.value;
      const token = localStorage.getItem('accessToken');

      fetch('/api/boards/${boardId}/comments', { // 댓글 작성 API 엔드포인트
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({
          boardId: boardId,
          content: content
        })
      }).then(response => {
        if (response.ok) {
          window.location.reload(); // 성공 시 페이지 새로고침
        } else {
          alert('댓글 작성에 실패했습니다.');
        }
      });
    });
  }


  function deleteBoard(boardId) {
    if (!confirm('정말 이 게시글을 삭제하시겠습니까?')) return;

    const token = localStorage.getItem('accessToken');
    fetch(`/api/board/${boardId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer ' + token
      }
    }).then(response => {
      if (response.ok) {
        alert('게시글이 삭제되었습니다.');
        window.location.href = '/';
      } else {
        alert('게시글 삭제에 실패했습니다.');
      }
    });
  }
</script>
</body>
</html>