<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
</head>
<body>
<div class="container">
  <h1 class="my-4">ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°</h1>

  <div class="card">
    <div class="card-body">
      <h5 class="card-title" id = "board-title" ></h5>

      <h6 class="card-subtitle mb-2 text-muted">
        ì‘ì„±ì: <span id="board-author"></span>
      </h6>

      <p class="card-text" id = "board-content"></p>

      <p class="card-text">
        <small class="text-muted">ì¡°íšŒìˆ˜: <span id = "board-views">0</span></small>
      </p>

      <p class="card-text">
        <small class="text-muted" id="board-createdAt"></small>
        <small class="text-muted" id="board-updateAt"></small>
      </p>



    </div>
  </div>
  <div class="mt-3">
    <button id="like-btn" class="btn btn-outline-success">ğŸ‘ ì¶”ì²œ <span id="like-count">0</span></button>
    <button id="dislike-btn" class="btn btn-outline-danger ml-2">ğŸ‘ ë¹„ì¶”ì²œ <span id="dislike-count">0</span></button>
  </div>
  <div class="mt-3" id="action-buttons" data-author-id="">
    <a href="/" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>

  <hr class="my-4">
  <h3>ëŒ“ê¸€</h3>

  <div class="mt-4">
    <h4>ëŒ“ê¸€ ì‘ì„±</h4>
    <form id="comment-form">
      <textarea name="content" class="form-control mb-2" rows="3" placeholder="ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
      <button type="submit" class="btn btn-primary">ëŒ“ê¸€ ì‘ì„±</button>
    </form>
  </div>

  <div id="comments-section" class="mb-4 mt-4">
    <ul id="comment-list" class="list-group">
    </ul>
  </div>
</div>

<script>
  // JWT í† í°ì„ íŒŒì‹±í•˜ëŠ” í•¨ìˆ˜ (jwt-decode ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì´ êµ¬í˜„)
  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    } catch (error) {
      console.error("JWT íŒŒì‹± ì˜¤ë¥˜:", error);
      return null;
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
  // detail.html <script> íƒœê·¸ ë‚´ë¶€

  // ... (parseJwt í•¨ìˆ˜ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€) ...

  document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('accessToken');

    // ìˆ˜ì • ë° ì‚­ì œ ë²„íŠ¼ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° (ì´ˆê¸°ì— display: none; ìƒíƒœ)
    const editBtn = document.getElementById('editBtn');
    const deleteBtn = document.getElementById('deleteBtn');

    // ê²Œì‹œê¸€ ì‘ì„±ìì˜ userIdë¥¼ HTML data- ì†ì„±ì—ì„œ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸°
    const boardAuthorH6Element = document.querySelector('h6[data-board-author-user-id]');
    const boardWriterId = boardAuthorH6Element ? boardAuthorH6Element.dataset.boardAuthorUserId : null;

    const boardId = window.location.pathname.split('/').pop();

    function setupRecommendationButtons(boardId) {
      document.getElementById('like-btn').addEventListener('click', () => handleRecommendationClick(boardId, 'LIKE'));
      document.getElementById('dislike-btn').addEventListener('click', () => handleRecommendationClick(boardId, 'DISLIKE'));
    }

    function renderBoard(board) {
      document.getElementById('board-title').textContent = board.title;
      document.getElementById('board-author').textContent = board.nickname;
      document.getElementById('board-content').textContent = board.content;
      document.getElementById('board-views').textContent = board.totalViews;
      document.getElementById('board-createdAt').textContent = 'ì‘ì„±ì¼: ' + new Date(board.createdAt).toLocaleString();

      // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ë¡œì§ì„ ìœ„í•´ ì‘ì„±ì IDë¥¼ data ì†ì„±ì— ì €ì¥
      document.getElementById('action-buttons').dataset.authorId = board.userId;

      updateRecommendationUI({
        likeCount: board.likeCount,
        dislikeCount: board.dislikeCount,
        userLiked: board.userLiked,
        userDisliked: board.userDisliked
      });
    }

    function renderComments(comments, container) {
      container.innerHTML = ''; // ê¸°ì¡´ ëŒ“ê¸€ ëª©ë¡ ì´ˆê¸°í™”

      if (!comments) return;

      comments.forEach(comment => {
        const li = document.createElement('li');
        li.className = 'list-group-item';

        if (comment.deleted) {
          li.innerHTML = `<p class="text-muted">${comment.content}</p>`;
        } else {
          li.innerHTML = `
                    <strong>${comment.nickname}</strong>
                    <p style="margin: 5px 0;">${comment.content}</p>
                    <small class="text-muted">${new Date(comment.createdAt).toLocaleString()}</small>
                `;
        }
        container.appendChild(li);

        // ëŒ€ëŒ“ê¸€ì´ ìˆìœ¼ë©´ ì¬ê·€ í˜¸ì¶œ
        if (comment.children && comment.children.length > 0) {
          const childUl = document.createElement('ul');
          childUl.className = 'list-group mt-2 ml-4';
          li.appendChild(childUl);
          renderComments(comment.children, childUl);
        }
      });
    }
    fetch(`/api/board/${boardId}`)
            .then(response => {
              if (!response.ok) {
                throw new Error("ê²Œì‹œê¸€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
              }
              return response.json();
            })
            .then(data => {
              renderBoard(data);
              renderComments(data.comments, document.getElementById('comment-list'));
              setupActionButtons(data.userId);
              setupCommentForm(boardId);
              setupRecommendationButtons(boardId);
            })
            .catch(error => {
              alert(error.message);
              window.location.href = '/';
            })

    if (token) {
      const decodedToken = parseJwt(token);
      // í† í° í˜ì´ë¡œë“œì— 'userId' í´ë ˆì„ì´ ìˆë‹¤ê³  ê°€ì •. ì—†ë‹¤ë©´ 'sub' ë“± ë‹¤ë¥¸ í‚¤ë¥¼ í™•ì¸í•˜ì„¸ìš”.
      // í˜„ì¬ userIdê°€ ë¬¸ìì—´ì´ë¯€ë¡œ, íŒŒì‹±ëœ userIdë„ ë¬¸ìì—´ì¼ ê²ƒì…ë‹ˆë‹¤.
      const currentUserId = decodedToken ? (decodedToken.userId || decodedToken.sub) : null;

      // ë‘ IDê°€ ëª¨ë‘ ì¡´ì¬í•˜ê³ , ê·¸ ë¬¸ìì—´ ê°’ì´ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
      if (currentUserId && boardWriterId && currentUserId === boardWriterId) {
        editBtn.style.display = 'inline-block';
        deleteBtn.style.display = 'inline-block';
      }

    }
  });
  function setupActionButtons(authorId) {
    const token = localStorage.getItem('accessToken');
    if (!token) return;

    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      const currentUserId = payload.id; // JWT í˜ì´ë¡œë“œì— idê°€ ìˆë‹¤ê³  ê°€ì •

      if (currentUserId === authorId) {
        const container = document.getElementById('action-buttons');
        const boardId = window.location.pathname.split('/').pop();

        const editBtn = document.createElement('a');
        editBtn.href = `/board/edit/${boardId}`; // ìˆ˜ì • í˜ì´ì§€ URL
        editBtn.className = 'btn btn-warning';
        editBtn.textContent = 'ìˆ˜ì •';

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-danger ml-2';
        deleteBtn.textContent = 'ì‚­ì œ';
        deleteBtn.onclick = () => deleteBoard(boardId);

        container.prepend(deleteBtn);
        container.prepend(editBtn);
      }
    } catch (e) {
      console.error("í† í° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
    }
  }

  function handleRecommendationClick(boardId, type) {
    const token = localStorage.getItem('accessToken');
    if (!token) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      return;
    }

    fetch(`/api/board/${boardId}/recommend`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ type: type }) // "LIKE" ë˜ëŠ” "DISLIKE"
    })
            .then(response => {
              if (!response.ok) throw new Error('ì¶”ì²œ/ë¹„ì¶”ì²œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              return response.json();
            })
            .then(data => {
              // ì„œë²„ë¡œë¶€í„° ë°›ì€ ìµœì‹  ë°ì´í„°ë¡œ UIë¥¼ ì—…ë°ì´íŠ¸
              updateRecommendationUI(data);
            })
            .catch(error => alert(error.message));
  }

  /** âœ¨ [ì¶”ê°€] ì¶”ì²œ/ë¹„ì¶”ì²œ ìˆ˜ì™€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜ */
  function updateRecommendationUI(data) {
    document.getElementById('like-count').textContent = data.likeCount;
    document.getElementById('dislike-count').textContent = data.dislikeCount;

    const likeBtn = document.getElementById('like-btn');
    const dislikeBtn = document.getElementById('dislike-btn');

    // 'ì¶”ì²œ' ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
    if (data.userLiked) {
      likeBtn.classList.replace('btn-outline-success', 'btn-success');
    } else {
      likeBtn.classList.replace('btn-success', 'btn-outline-success');
    }

    // 'ë¹„ì¶”ì²œ' ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
    if (data.userDisliked) {
      dislikeBtn.classList.replace('btn-outline-danger', 'btn-danger');
    } else {
      dislikeBtn.classList.replace('btn-danger', 'btn-outline-danger');
    }
  }

  function setupCommentForm(boardId) {
    const commentForm = document.getElementById('comment-form');
    commentForm.addEventListener('submit', function (event) {
      event.preventDefault(); // í¼ ê¸°ë³¸ ë™ì‘ ë°©ì§€

      const content = event.target.content.value;
      const token = localStorage.getItem('accessToken');

      fetch('/api/boards/${boardId}/comments', { // ëŒ“ê¸€ ì‘ì„± API ì—”ë“œí¬ì¸íŠ¸
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({
          boardId: boardId,
          content: content
        })
      }).then(response => {
        if (response.ok) {
          window.location.reload(); // ì„±ê³µ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        } else {
          alert('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      });
    });
  }


  function deleteBoard(boardId) {
    if (!confirm('ì •ë§ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const token = localStorage.getItem('accessToken');
    fetch(`/api/board/${boardId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer ' + token
      }
    }).then(response => {
      if (response.ok) {
        alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.location.href = '/';
      } else {
        alert('ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    });
  }
</script>
</body>
</html>